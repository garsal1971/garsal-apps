<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ts_reminder_presets</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #1a1a2e; color: #e0e0e0; font-family: monospace; padding: 1rem; }
  h1 { font-size: 1.1rem; color: #7c83fd; margin-bottom: 0.4rem; }
  .sub { font-size: 0.75rem; color: #666; margin-bottom: 1.5rem; }

  /* Tabella dati live */
  .tbl-wrap { overflow-x: auto; margin-bottom: 1.5rem; }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  th { background: #0d0d1a; color: #7c83fd; padding: 0.5rem 0.6rem; text-align: left; border-bottom: 1px solid #333; }
  td { padding: 0.45rem 0.6rem; border-bottom: 1px solid #222; }
  tr:hover td { background: #1f1f3a; }
  .badge-on  { color: #00b894; }
  .badge-off { color: #e74c3c; }

  /* Blocchi SQL generati */
  .block { margin-bottom: 1.5rem; }
  .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
  .block-title { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
  .btn-copy {
    background: #7c83fd; color: #fff; border: none;
    padding: 0.5rem 1.1rem; border-radius: 6px;
    font-size: 0.9rem; cursor: pointer; min-width: 80px;
  }
  .btn-copy.ok { background: #00b894; }
  pre {
    background: #0d0d1a; border: 1px solid #333; border-radius: 6px;
    padding: 1rem; font-size: 0.78rem; line-height: 1.6;
    overflow-x: auto; white-space: pre-wrap; word-break: break-word;
  }
  #status { font-size: 0.8rem; color: #888; margin-bottom: 1rem; }
  #status.err { color: #e74c3c; }
</style>
</head>
<body>

<h1>ts_reminder_presets</h1>
<p class="sub">Dati live da Supabase</p>

<p id="status">Caricamento...</p>

<div class="tbl-wrap">
  <table id="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th>label</th>
        <th>offset_minutes</th>
        <th>sort_order</th>
        <th>active</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="block" id="insertBlock" style="display:none">
  <div class="block-header">
    <span class="block-title">INSERT (da DB)</span>
    <button class="btn-copy" onclick="copyEl(this,'sqlInsert')">Copia</button>
  </div>
  <pre id="sqlInsert"></pre>
</div>

<script>
const SUPABASE_URL = 'https://jajlmmdsjlvzgcxiiypk.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphamxtbWRzamx2emdjeGlpeXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTU0NjYsImV4cCI6MjA4NTUzMTQ2Nn0.ikaipwxOvIn43epayQ4mSZQkXtin3aaGEPouafwJFxU';

async function load() {
    const url = `${SUPABASE_URL}/rest/v1/ts_reminder_presets?select=label,offset_minutes,sort_order,active&order=sort_order.asc`;
    try {
        const res = await fetch(url, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const rows = await res.json();
        render(rows);
    } catch (e) {
        const s = document.getElementById('status');
        s.textContent = 'Errore: ' + e.message;
        s.classList.add('err');
    }
}

function render(rows) {
    document.getElementById('status').textContent = rows.length + ' righe caricate';

    const tbody = document.getElementById('tbody');
    tbody.innerHTML = rows.map((r, i) => `
        <tr>
            <td>${i + 1}</td>
            <td>${r.label}</td>
            <td>${r.offset_minutes}</td>
            <td>${r.sort_order}</td>
            <td class="${r.active ? 'badge-on' : 'badge-off'}">${r.active ? 'si' : 'no'}</td>
        </tr>
    `).join('');

    // Genera INSERT dinamico dai dati reali
    const vals = rows.map(r =>
        `('${r.label}', ${r.offset_minutes}, ${r.sort_order})`
    ).join(',\n');
    const sql = `INSERT INTO ts_reminder_presets (label, offset_minutes, sort_order) VALUES\n${vals}\nON CONFLICT (label) DO NOTHING;`;
    document.getElementById('sqlInsert').textContent = sql;
    document.getElementById('insertBlock').style.display = '';
}

function copyEl(btn, id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '✓ Copiato';
        btn.classList.add('ok');
        setTimeout(() => { btn.textContent = 'Copia'; btn.classList.remove('ok'); }, 2000);
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = '✓ Copiato';
        btn.classList.add('ok');
        setTimeout(() => { btn.textContent = 'Copia'; btn.classList.remove('ok'); }, 2000);
    });
}

load();
</script>
</body>
</html>
